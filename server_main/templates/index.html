<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Monitor | Shadcn UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #020817;
      }
      .shadcn-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }
      .severity-high {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .severity-low {
        background-color: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        border-radius: 9999px;
        padding: 0.125rem 0.625rem;
        font-size: 0.75rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header class="sticky top-0 z-50 w-full border-b bg-white/95 backdrop-blur">
      <div
        class="container mx-auto flex h-16 items-center justify-between px-4"
      >
        <div class="flex items-center gap-2">
          <i data-lucide="shield-check" class="text-blue-600"></i>
          <span class="text-lg font-bold tracking-tight"
            >Security Dashboard</span
          >
        </div>
        <div class="flex items-center gap-4">
          <button
            onclick="openConfig()"
            class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-900 transition-colors"
          >
            <i data-lucide="settings" class="h-4 w-4"></i>
            Configuración
          </button>
          <div
            class="flex items-center gap-1.5 text-sm font-medium text-slate-500 border-l pl-4"
          >
            <span class="relative flex h-2 w-2">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-2 w-2 bg-green-500"
              ></span>
            </span>
            Live Monitor
          </div>
        </div>
      </div>
    </header>

    <main class="container mx-auto py-8 px-4">
      <!-- Stats Row -->
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-8">
        <!-- Sensor Salud: DB -->
        <div
          class="shadcn-card p-6 border-l-4 border-slate-200"
          id="dbHealthCard"
        >
          <div class="flex items-center justify-between space-y-0 pb-2">
            <h3
              class="text-sm font-medium text-slate-500 uppercase tracking-wider"
            >
              Estado Database
            </h3>
            <span class="relative flex h-3 w-3">
              <span
                id="dbPing"
                class="absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"
              ></span>
              <span
                id="dbDot"
                class="relative inline-flex rounded-full h-3 w-3 bg-slate-500"
              ></span>
            </span>
          </div>
          <div class="text-2xl font-bold" id="dbStatus">OFFLINE</div>
          <p class="text-[10px] text-slate-400 mt-1" id="dbLastSeen">
            Esperando señal...
          </p>
        </div>

        <!-- Sensor Salud: Nginx -->
        <div
          class="shadcn-card p-6 border-l-4 border-slate-200"
          id="nginxHealthCard"
        >
          <div class="flex items-center justify-between space-y-0 pb-2">
            <h3
              class="text-sm font-medium text-slate-500 uppercase tracking-wider"
            >
              Estado Nginx/Edge
            </h3>
            <span class="relative flex h-3 w-3">
              <span
                id="nginxPing"
                class="absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"
              ></span>
              <span
                id="nginxDot"
                class="relative inline-flex rounded-full h-3 w-3 bg-slate-500"
              ></span>
            </span>
          </div>
          <div class="text-2xl font-bold" id="nginxStatus">OFFLINE</div>
          <p class="text-[10px] text-slate-400 mt-1" id="nginxLastSeen">
            Esperando señal...
          </p>
        </div>

        <!-- Stats logs se mantienen pero se ajustan IDs -->
        <div class="shadcn-card p-6">
          <div class="flex items-center justify-between space-y-0 pb-2">
            <h3
              class="text-sm font-medium text-slate-500 uppercase tracking-wider"
            >
              Alertas DB
            </h3>
            <i data-lucide="shield-alert" class="h-4 w-4 text-red-500"></i>
          </div>
          <div class="text-2xl font-bold text-red-600" id="sqliCount">0</div>
          <p class="text-xs text-slate-400 mt-1">Detecciones críticas</p>
        </div>

        <div class="shadcn-card p-6">
          <div class="flex items-center justify-between space-y-0 pb-2">
            <h3
              class="text-sm font-medium text-slate-500 uppercase tracking-wider"
            >
              Peticiones Total
            </h3>
            <i data-lucide="refresh-cw" class="h-4 w-4 text-blue-500"></i>
          </div>
          <div class="text-2xl font-bold" id="httpCount">0</div>
          <p class="text-xs text-slate-400 mt-1">Tráfico analizado</p>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Sección 1: Base de Datos / Seguridad -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 px-2">
            <i data-lucide="database" class="text-red-600 h-5 w-5"></i>
            <h2 class="text-lg font-bold tracking-tight">
              Security Alerts (Database)
            </h2>
          </div>
          <div class="shadcn-card overflow-hidden">
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
              <table class="w-full text-sm">
                <thead class="sticky top-0 bg-white border-b z-10">
                  <tr>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Hora
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Firma / Ataque
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Origen
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Acción
                    </th>
                  </tr>
                </thead>
                <tbody id="dbTableBody">
                  <tr id="noDbLogs">
                    <td colspan="4" class="p-8 text-center text-slate-400">
                      Sin alertas de DB
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Sección 2: Nginx / Tráfico -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 px-2">
            <i data-lucide="server" class="text-blue-600 h-5 w-5"></i>
            <h2 class="text-lg font-bold tracking-tight">
              Access Logs (Nginx)
            </h2>
          </div>
          <div class="shadcn-card overflow-hidden">
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
              <table class="w-full text-sm">
                <thead class="sticky top-0 bg-white border-b z-10">
                  <tr>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Hora
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Método
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Recurso / URI
                    </th>
                    <th class="h-10 px-4 text-left font-medium text-slate-500">
                      Acción
                    </th>
                  </tr>
                </thead>
                <tbody id="nginxTableBody">
                  <tr id="noNginxLogs">
                    <td colspan="4" class="p-8 text-center text-slate-400">
                      Sin tráfico Nginx
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      lucide.createIcons();

      let counts = { sqli: 0, http: 0 };
      const ips = {};
      let bannedList = [];

      async function banPerson(ip) {
        if (
          !confirm(
            `¿Estás seguro de bloquear la IP ${ip}? Esto cortará su acceso mediante IPTABLES.`
          )
        )
          return;

        try {
          const response = await fetch("/api/ban", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ip }),
          });
          const result = await response.json();
          if (response.ok) {
            alert(result.message);
          } else {
            alert("Error: " + result.message);
          }
        } catch (e) {
          alert("Error al conectar con el servidor.");
        }
      }

      function addLog(data) {
        const timestamp = new Date().toLocaleTimeString();

        if (data.event_type === "alert") {
          const noDb = document.getElementById("noDbLogs");
          if (noDb) noDb.remove();

          counts.sqli++;
          document.getElementById("sqliCount").innerText = counts.sqli;

          const src_ip = data.src_ip || "N/A";
          ips[src_ip] = (ips[src_ip] || 0) + 1;

          const row = document.createElement("tr");
          row.className =
            "border-b bg-red-50/20 hover:bg-red-100/30 transition-colors";
          row.innerHTML = `
                    <td class="p-4 font-mono text-xs">${timestamp}</td>
                    <td class="p-4">
                        <div class="font-bold text-red-700 text-xs">${
                          data.alert.signature
                        }</div>
                        <div class="text-[10px] text-slate-400 truncate max-w-[200px]">${
                          data.payload_printable || ""
                        }</div>
                    </td>
                    <td class="p-4 font-mono text-xs text-slate-600">${src_ip}</td>
                    <td class="p-4">
                        <button onclick="banPerson('${src_ip}')" class="px-2 py-1 bg-red-600 text-white text-[10px] rounded hover:bg-red-700 transition-colors">BAN</button>
                    </td>
                `;
          document.getElementById("dbTableBody").prepend(row);
        } else {
          const noNginx = document.getElementById("noNginxLogs");
          if (noNginx) noNginx.remove();

          counts.http++;
          document.getElementById("httpCount").innerText = counts.http;

          const src_ip = data.src_ip || data.sensor_source || "N/A";
          const row = document.createElement("tr");
          row.className = "border-b hover:bg-slate-50 transition-colors";

          const method = data.http ? data.http.http_method : "GET";
          const uri = data.http ? data.http.url : data.nginx_msg || "/";

          row.innerHTML = `
                    <td class="p-4 font-mono text-xs">${timestamp}</td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100">${method}</span></td>
                    <td class="p-4 text-xs text-slate-600 truncate max-w-[200px]">${uri}</td>
                    <td class="p-4">
                         <button onclick="banPerson('${src_ip}')" class="px-2 py-1 border border-red-200 text-red-600 text-[10px] rounded hover:bg-red-50 transition-colors">BAN</button>
                    </td>
                `;
          document.getElementById("nginxTableBody").prepend(row);
        }
        updateTopSource();
      }

      function updateTopSource() {
        let maxIp = "N/A";
        let maxCount = 0;
        for (const ip in ips) {
          if (ips[ip] > maxCount) {
            maxCount = ips[ip];
            maxIp = ip;
          }
        }
        document.getElementById("topSourceIP").innerText = maxIp;
        document.getElementById("topSource").innerText = maxCount + " ataques";
      }

      function updateHealthStatus(health) {
        const sensors = ["db", "nginx"];
        sensors.forEach((s) => {
          const data = health[s];
          const card = document.getElementById(`${s}HealthCard`);
          const dot = document.getElementById(`${s}Dot`);
          const ping = document.getElementById(`${s}Ping`);
          const statusText = document.getElementById(`${s}Status`);
          const lastSeen = document.getElementById(`${s}LastSeen`);

          if (data.status === "ONLINE") {
            card.classList.replace("border-slate-200", "border-green-500");
            dot.classList.replace("bg-slate-500", "bg-green-500");
            ping.classList.replace("bg-slate-400", "bg-green-400");
            ping.classList.add("animate-ping");
            statusText.innerText = "ONLINE";
            statusText.classList.add("text-green-600");
            lastSeen.innerText = `Última señal: ${data.last_seen} (IP: ${data.ip})`;
          } else {
            card.classList.replace("border-green-500", "border-slate-200");
            dot.classList.replace("bg-green-500", "bg-slate-500");
            ping.classList.replace("bg-green-400", "bg-slate-400");
            ping.classList.remove("animate-ping");
            statusText.innerText = "OFFLINE";
            statusText.classList.remove("text-green-600");
          }
        });
      }

      setInterval(async () => {
        try {
          const response = await fetch("/api/get-latest");
          const data = await response.json();

          // Procesar Logs
          if (data.logs) data.logs.forEach((log) => addLog(log));

          // Procesar Salud
          if (data.health) updateHealthStatus(data.health);
        } catch (e) {}
      }, 1500);

      // --- Gestión de Configuración ---
      async function openConfig() {
        const response = await fetch("/api/config");
        const config = await response.json();

        document.getElementById("dbIpInput").value = config.db_ip;
        document.getElementById("nginxIpInput").value = config.nginx_ip;
        document.getElementById("lastUpdateText").innerText =
          config.last_update;

        document.getElementById("configModal").classList.remove("hidden");
      }

      function closeConfig() {
        document.getElementById("configModal").classList.add("hidden");
      }

      async function saveConfig() {
        const db_ip = document.getElementById("dbIpInput").value;
        const nginx_ip = document.getElementById("nginxIpInput").value;

        const response = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ db_ip, nginx_ip }),
        });

        if (response.ok) {
          alert("Configuración guardada correctamente");
          closeConfig();
        }
      }
    </script>
    <!-- Modal de Configuración -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4"
    >
      <div
        class="shadcn-card w-full max-w-md bg-white shadow-2xl animate-in fade-in zoom-in duration-200"
      >
        <div class="p-6 border-b flex items-center justify-between">
          <h2 class="text-lg font-bold">Infraestructura</h2>
          <button
            onclick="closeConfig()"
            class="text-slate-400 hover:text-slate-600"
          >
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div class="space-y-2">
            <label class="text-sm font-medium leading-none"
              >IP Base de Datos (MySQL)</label
            >
            <input
              type="text"
              id="dbIpInput"
              class="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium leading-none"
              >IP Nodo Borde (Nginx/Suricata)</label
            >
            <input
              type="text"
              id="nginxIpInput"
              class="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <p class="text-[10px] text-slate-400">
            Última actualización: <span id="lastUpdateText">N/A</span>
          </p>
        </div>
        <div class="p-6 border-t flex justify-end gap-3">
          <button
            onclick="closeConfig()"
            class="px-4 py-2 border rounded-md text-sm font-medium hover:bg-slate-50"
          >
            Cancelar
          </button>
          <button
            onclick="saveConfig()"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700"
          >
            Guardar Cambios
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
